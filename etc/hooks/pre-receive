#!/bin/bash
# set up logging; stdout is tee'd to compile log, stderr appends to debug log
LOG_DIR=$(dirname $PWD)/.log
exec 1> >(tee -a $LOG_DIR/compile.log)
exec 2> >(cat >> $LOG_DIR/debug.log)

# main script
set -xo pipefail

GIT_DIR=$(pwd)
WORK_DIR=$(dirname $GIT_DIR)
BP_DIR=$WORK_DIR/.bp

touch $LOG_DIR/started
echo "-----> Heroku receiving push"

read oldrev newrev ref
git --work-tree=$WORK_DIR checkout -f $newrev

echo "-----> Updating buildpack..."
git clone https://github.com/heroku/heroku-buildpack-ruby.git $BP_DIR 1>&2

# run detect / compile / release in a clean environment
env -i PATH=$PATH \
  BP_DIR=$BP_DIR GIT_DIR=$GIT_DIR LOG_DIR=$LOG_DIR WORK_DIR=$WORK_DIR \
  bash -s <<'EOF'
    set -x
    echo "-----> $($BP_DIR/bin/detect $WORK_DIR) app detected"

    $BP_DIR/bin/compile $WORK_DIR $GIT_DIR/.cache ; STATUS=$?
    $BP_DIR/bin/detect  $WORK_DIR &> $LOG_DIR/detect.log
    $BP_DIR/bin/release $WORK_DIR &> $LOG_DIR/release.log

    exit $STATUS
EOF

if [ $? != 0 ]; then
  echo "!     Heroku push rejected"
else
  echo "-----> Compiled slug size is 628K"
fi

# POST artifacts

touch $LOG_DIR/finished