#!/bin/bash
# set up logging; stdout is tee'd to compile log, stderr appends to debug log
TMP_DIR=$(dirname $PWD)/.tmp
exec 1> >(tee -a $TMP_DIR/compile.log)
exec 2> >(cat >> $TMP_DIR/debug.log)

# main script
set -xo pipefail
source $TMP_DIR/build_env

GIT_DIR=$(pwd)
WORK_DIR=$(dirname $GIT_DIR)

touch $TMP_DIR/start

read oldrev newrev ref
slugc --trace --range=$oldrev..$newrev --meta=$TMP_DIR/metadata.yml --repo-dir=$GIT_DIR 2>&1
touch $TMP_DIR/detect.log
touch $TMP_DIR/release.log

STATUS=$?
echo $STATUS > $TMP_DIR/exit
exit $STATUS
