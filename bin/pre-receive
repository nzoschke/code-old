#!/bin/bash
# set up logging; stdout is tee'd to compile log, stderr appends to debug log
GIT_DIR=$PWD
TMP_DIR=$(dirname $PWD)/.tmp
exec 1> >(tee -a $TMP_DIR/compile.log)
exec 2> >(cat >> $TMP_DIR/debug.log)

# main script
set -xo pipefail

touch $TMP_DIR/start
read oldrev newrev ref

# run slugc with user-specified env via envdir in a clean environment
env -i \
  $(which envdir) $TMP_DIR/env \
  $(which slugc)  --trace --range=$oldrev..$newrev --meta=$TMP_DIR/metadata.yml --repo-dir=$GIT_DIR 2>&1
STATUS=$?

touch $TMP_DIR/detect.log
touch $TMP_DIR/release.log

echo $STATUS > $TMP_DIR/exit
exit $STATUS
