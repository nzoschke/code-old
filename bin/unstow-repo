#!/bin/bash
# usage unstow-repo URL WORK_DIR

# assert WORK_DIR does not exist. Special case /app, which can safely be cleaned
if [ -d $2 ]; then
  [ $2 != "/app" ] && { echo error: $2 already exists; exit 1; }
  LOG=$(find $2 -depth -mindepth 1 -print0 | xargs -0 rm -rfv)
fi

# set up debug logging
mkdir -p $2/.log
exec &> $2/.log/debug.log
echo "+ rm $LOG"

set -xeo pipefail

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
APP_DIR=$(dirname $BIN_DIR)

REPO_URL=$1
WORK_DIR=$2

(
  cd $WORK_DIR
  git init --bare .git

  STATUS=$(curl -o repo.tgz -w "%{http_code}" "$REPO_URL" || true)
  [ $STATUS == "200" ] && tar xfvz repo.tgz -C .git

  rm -rf $REPO_DIR/hooks
  cp -R $APP_DIR/etc/hooks .git

  echo Finished at $(date)
)